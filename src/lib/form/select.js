/**
  *
  * @authors yutent (yutent.io@gmail.com)
  * @date    2021-02-05 16:32:07
  * @version v1.0.3
  * 
  */

import"../scroll/index.js";import"../icon/index.js";import $ from"../utils.js";function parseOptions(t,e){let s="";for(let i of t)if(i.list){s+=`<dt>${i.name}</dt>`;for(let t of i.list)e.DICT[t.value]=t,t.disabled||e.LIST.push(t),s+=`<dd sub ${t.disabled?"disabled":`data-idx="${e.LIST.length-1}"`} ${t.value===e.value?"focus":""}>${t.label}</dd>`}else i.disabled||e.LIST.push(i),e.DICT[i.value]=i,s+=`<dd ${i.disabled?"disabled":`data-idx="${e.LIST.length-1}"`} ${i.value===e.value?"focus":""}>${i.label}</dd>`;return s}export default class Select extends HTMLElement{static get observedAttributes(){return["label","placeholder","multi","value","options","mvidx","readonly","disabled"]}props={label:"",placeholder:"",multi:"",value:"",options:"",mvidx:null,readonly:!1,disabled:!1};constructor(){super(),Object.defineProperty(this,"root",{value:this.attachShadow({mode:"open"}),writable:!0,enumerable:!1,configurable:!0}),this.root.innerHTML='<style>undefined</style> <div class="label"> <slot class="prepend" name="prepend"></slot> <input readonly /> <wc-icon class="arrow" is="left"></wc-icon> <slot class="append" name="append"></slot> <div class="opt-box"> <wc-scroll> <dl class="list"></dl> </wc-scroll> </div> </div> ',this.__OUTER__=this.root.children[1],this.__PREPEND__=this.__OUTER__.children[0],this.__INPUT__=this.__OUTER__.children[1],this.__APPEND__=this.__OUTER__.children[3],this.__OPTG__=this.__OUTER__.children[4]}get readOnly(){return this.props.readonly}set readOnly(t){var e=typeof t;t!==this.props.readonly&&("boolean"===e&&t||"boolean"!==e?(this.props.readonly=!0,this.setAttribute("readonly","")):(this.props.readonly=!1,this.removeAttribute("readonly")))}get disabled(){return this.props.disabled}set disabled(t){var e=typeof t;t!==this.props.disabled&&("boolean"===e&&t||"boolean"!==e?(this.props.disabled=!0,this.setAttribute("disabled",""),this.__INPUT__.setAttribute("disabled","")):(this.props.disabled=!1,this.removeAttribute("disabled"),this.__INPUT__.removeAttribute("disabled")))}get value(){return this.props.value}set value(t){var{DICT:e,active:s}=this.props;this.props.value=t,this.__INPUT__.value=e&&e[t]&&e[t].label||t,s||this._updateStyle()}_renderOptions(t){this.props.DICT={},this.props.LIST=[];var e=this.__OPTG__.firstElementChild.firstElementChild;e.innerHTML=parseOptions(t,this.props),this.props.ITEMS=Array.from(e.children).filter(t=>"DD"===t.tagName&&!t.hasAttribute("disabled")),this.value=this.props.value}_moveSelect(t){var{LIST:e,DICT:s,ITEMS:i}=this.props;if(e&&e.length){t.preventDefault();var l=38===t.keyCode?-1:1;null===this.props.mvidx?this.props.mvidx=0:this.props.mvidx+=l,this.props.mvidx<0?this.props.mvidx=0:this.props.mvidx>i.length-1&&(this.props.mvidx=i.length-1),i.forEach((t,e)=>{e===this.props.mvidx?(this.__OPTG__.firstElementChild.scrollTop=t.offsetTop-150,t.setAttribute("focus","")):t.removeAttribute("focus")})}}_updateStyle(t){var{LIST:e,ITEMS:s,value:i}=this.props;if(e&&e.length){if(void 0===t)for(let s,l=-1;s=e[++l];)if(i===s.value){t=l;break}this.props.mvidx=t,s.forEach((e,s)=>{s===t?e.setAttribute("focus",""):e.removeAttribute("focus")})}}_fetchSelect(t,e){var s=this.props.LIST[t];this.value=s.value,this.dispatchEvent(new CustomEvent("select",{detail:s})),e&&this._updateStyle(t),this.props.active=!1,this.__OPTG__.classList.remove("show")}connectedCallback(){for(var t=this.__PREPEND__.assignedNodes(),e=this.__APPEND__.assignedNodes();t.length>1;)this.removeChild(t.pop());for(;e.length>1;)this.removeChild(e.pop());function s(){var{x:t,y:e,width:s}=this.getBoundingClientRect(),i=this.getAttribute("size");this.props.active=!0,e+=i&&"mini"===i?32:50,this.__OPTG__.style.cssText=`left:${t}px;top:${e}px;width:${s}px;`}t.length&&"textarea"!==this.props.type&&this.__OUTER__.setAttribute("prepend",""),e.length&&"textarea"!==this.props.type&&this.__OUTER__.setAttribute("append",""),this._handleKeydown=$.catch(this.__INPUT__,"keydown",t=>{if(!this.disabled&&!this.readOnly)return 38===t.keyCode||40===t.keyCode?this.props.active?this._moveSelect(t):(s.call(this),void this.__OPTG__.classList.toggle("show",!0)):13===t.keyCode&&null!==this.props.mvidx&&this.props.active?this._fetchSelect(this.props.mvidx):void 0}),this._activeFn=$.bind(this.__INPUT__,"click",t=>{var{options:e}=this.props;this.disabled||this.readOnly||(s.call(this),this.__OPTG__.classList.toggle("show"))}),this._handleSelect=$.bind(this.__OPTG__,"click",t=>{"DD"!==t.target.tagName||t.target.hasAttribute("disabled")||(this._fetchSelect(+t.target.dataset.idx,!0),this.dispatchEvent(new CustomEvent("input")))}),this._inactiveFn=$.outside(this,t=>{this.__OPTG__.classList.toggle("show",!1),this.props.active=!1})}attributeChangedCallback(t,e,s){if(e!==s)switch(t){case"label":case"placeholder":this.__INPUT__.setAttribute("placeholder",s);break;case"options":if(s){try{this._renderOptions(JSON.parse(s))}catch(t){}this.removeAttribute("options")}break;case"value":this.value=s;break;case"readonly":case"disabled":var i=t;"readonly"===i&&(i="readOnly"),this[i]=!0}}disconnectedCallback(){$.unbind(this.__INPUT__,"keydown",this._handleKeydown),$.unbind(this.__INPUT__,"click",this._activeFn),$.unbind(this.__OPTG__,"click",this._handleSelect),$.clearOutside(this._inactiveFn)}}

if(!customElements.get('wc-select')){
  customElements.define('wc-select', Select)
}
